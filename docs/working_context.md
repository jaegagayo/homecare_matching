# 위치 기반 요양보호사 매칭 시스템 - 개발 컨텍스트

## 📋 프로젝트 개요

이 프로젝트는 수요자 위치를 기준으로 최적의 요양보호사를 매칭해주는 시스템입니다. 
네이버 지도 API와의 연동을 최소화하고, 효율적인 위치 기반 필터링을 통해 성능을 최적화합니다.

## 🏗️ 시스템 아키텍처

### 현재 설계된 매칭 프로세스 (6단계)

```mermaid
graph TD
    A[1. 요청 검증] --> B[2. 선호시간대 필터링]
    B --> C[3. 반경 필터링 15km]
    C --> D[4. 선호조건 필터링 LLM]
    D --> E[5. ETA 계산]
    E --> F[6. 최종 선정 상위 5명]
```

1. **요청 검증**: 서비스 요청 위치 DTO 수신 및 좌표 유효성 검증
2. **선호시간대 필터링**: 신청자 선호시간대와 요양보호사 근무시간대 겹침 확인 → **기존 설계에서 누락된 단계로 새롭게 구현 필요**
3. **반경 필터링**: 15km 반경 내 근거리 후보군 로드 (Haversine 공식 사용)
4. **선호조건 필터링**: OpenRouter LLM으로 조건부합 후보군 생성 → ✅ **PR #25에서 구현 완료**
5. **ETA 계산**: 네이버 Direction 5 API를 통한 실제 소요시간 계산 → ✅ **PR #24에서 구현 완료**
6. **최종 선정**: ETA 기준 정렬 후 상위 5명 선정

## 🔄 현재 Stacking Workflow 상태

### PR 의존성 체인
```
PR #20 (gRPC 구현) → PR #21 (네이버 지도 API 스터브) → PR #23 (위치 필터링) → PR #24 (ETA 계산) → PR #25 (LLM 필터링) ✅
```

- ✅ **PR #20**: gRPC 서버/클라이언트 구현 완료 (MERGED)
- ✅ **PR #21**: 네이버 지도 API 클라이언트 구현 및 목 데이터 추가 (MERGED)
- ✅ **PR #22**: OpenRouter LLM 서비스 구현 완료 (MERGED) - 자연어 → 구조화된 데이터 변환
- ✅ **PR #23**: 위치 기반 15km 반경 필터링 시스템 구현 (MERGED)
- ✅ **PR #24**: 네이버 Direction 5 API를 이용한 실시간 ETA 계산 구현 (MERGED)
- ✅ **PR #25**: OpenRouter LLM 서비스 연동한 선호조건 필터링 구현 완료

## 🚧 최근 작업 진행 상황 (2025-09-02)

### 진행 중인 작업
- **매칭 API 기본 구조 구현**: 6단계 매칭 프로세스 뼈대 구현 중
- **데이터베이스 연동 이슈 해결**: PostgreSQL 데이터베이스 연결 및 ORM 매핑 문제 해결
- **DTO 구조 정리**: userId 필드 누락, baseLocation vs location 필드 이슈 등 해결
- **API 테스트 환경 구축**: HTTP API 테스트 스크립트 작성 및 디버깅 진행

### 발견된 이슈들
- **HTTP API 응답 문제**: 현재 API 호출 시 정상적인 응답이 나오지 않는 상태
- **데이터 매핑 이슈**: 요양보호사 name 필드가 None으로 표시되는 문제
- **성능 문제**: 응답 시간이 예상보다 길어지는 이슈
- **DTO 검증 오류**: 일부 필수 필드 누락으로 인한 Pydantic 검증 실패
- **선호시간대 필터링 오류**: 선호시간대 필터링에 속하는 사람이 있을 때, 신청정보에서 요구하는 시간대에 근무 가능한 요양보호사가 있음에도 통과되지 않음

## 🔧 매칭 API 현재 구현 상태

### 📋 부분 구현된 기능들

#### 🚧 매칭 프로세스 6단계 (부분 구현)

1. **요청 검증** ⚠️: LocationDTO 기반 검증 구조 있음, 완전 동작 미확인
2. **선호시간대 필터링** ⚠️: `time_utils.py` 유틸리티 구현, 실제 연동 이슈 있음
3. **반경 필터링** ⚠️: Haversine 공식 구현, 위치 데이터 매핑 문제
4. **선호조건 필터링** ⚠️: OpenRouter LLM 연동 코드 있음, 실제 동작 불안정
5. **ETA 계산** ⚠️: 네이버 Direction API 연동 구조 있음, 목 데이터 의존
6. **최종 선정** ⚠️: 응답 생성 로직 있음, 필드 누락 이슈

#### 🚨 주요 미해결 이슈

- **API 응답 실패**: HTTP 호출 시 일관된 응답 생성 실패
- **데이터베이스 연동**: ORM과 실제 스키마 간 불일치 문제
- **DTO 검증 실패**: 필수 필드 누락으로 인한 Pydantic 오류
- **성능 문제**: 예상보다 긴 응답 시간 및 타임아웃 이슈

## 🎯 우선 해결해야 할 작업 목록

### 🚨 긴급 수정 사항

#### 1. API 기본 동작 안정화
- **HTTP 응답 실패**: 매칭 API 호출 시 일관된 응답 생성되도록 수정
- **DTO 검증 오류**: Pydantic 검증 실패 이슈 해결
- **데이터베이스 연동**: ORM 모델과 실제 스키마 매핑 문제 해결
- **선호시간대 오류**: 선호시간대 필터링 오류 해결

#### 2. 데이터 품질 문제 해결
- **필수 필드 누락**: name, userId 등 필수 필드가 제대로 매핑되지 않는 문제
- **위치 데이터**: baseLocation vs location 필드 일관성 문제
- **응답 구조**: 예상되는 응답 형식과 실제 응답 간 불일치

#### 3. 기본 테스트 통과
- **단순 매칭 테스트**: 최소한의 매칭 결과라도 정상 반환되도록 수정
- **에러 처리**: 각 단계별 실패 시 적절한 에러 메시지 반환
- **로깅 개선**: 디버깅을 위한 상세 로그 유지

## 🔗 참고해야 할 파일들

- `app/api/matching.py`: 주요 매칭 로직 (현재 분석 완료)
- `app/dto/matching.py`: DTO 구조
- `app/models/matching.py`: SQLAlchemy ORM 모델
- `app/dto/converting.py`: 구조화된 선호조건 데이터 모델
- `app/utils/location_calculator.py`: 위치 계산 유틸리티
- `app/database.py`: 데이터베이스 연결 설정
- `app/repositories/caregiver_repository.py`: 요양보호사 데이터 리포지토리

## 🚀 구현 예상 효과

- **성능 향상**: 시간대가 맞지 않는 요양보호사는 위치 계산조차 하지 않아 처리량 감소
- **정확도 향상**: 실제 비즈니스 요구사항 반영한 매칭 로직 구현
- **사용자 경험 개선**: 더 정확하고 빠른 매칭 결과 제공
- **시스템 완성도 향상**: 응답 DTO의 모든 필드가 실제 데이터로 채워짐

---

**마지막 업데이트**: 2025-08-31
**현재 브랜치**: `i-11/matching-api`
**현재 상태**: 데이터베이스 ORM 연동 완료, 선호시간대 필터링 시스템 설계 완료
**다음 작업**: 선호시간대 비교 유틸리티 함수 구현 시작

### 🎯 다음 작업자를 위한 가이드
1. **검증 방법**: 간단한 검증 스크립트 작성으로 기능 확인 (기존 gRPC/LLM 테스트 방식 참고)
2. **주의사항**: ORM 접근 1회 원칙 유지하며 구현
3. **데이터베이스 연동 확인**: ORM 설정이 정상적으로 작동하는지 테스트 (데이터베이스 연결 문자열 확인 필요)
4. **검증 스크립트 작성**: 데이터베이스 ORM 연동 검증을 위한 테스트 스크립트 작성
   - 데이터베이스 연결 테스트
   - ORM 모델과 실제 스키마 매핑 검증
   - 실제 데이터 조회 기능 테스트
5. **환경 변수 설정**: `.env` 파일에 DATABASE_URL 설정 확인
   ```bash
   DATABASE_URL=postgresql+asyncpg://username:password@localhost:5432/homecare_db
   ```