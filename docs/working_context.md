# 위치 기반 요양보호사 매칭 시스템 - 개발 컨텍스트

## 📋 프로젝트 개요

이 프로젝트는 수요자 위치를 기준으로 최적의 요양보호사를 매칭해주는 시스템입니다. 
네이버 지도 API와의 연동을 최소화하고, 효율적인 위치 기반 필터링을 통해 성능을 최적화합니다.

## 🏗️ 시스템 아키텍처

### 현재 설계된 매칭 프로세스 (6단계)

```mermaid
graph TD
    A[1. 요청 검증] --> B[2. 선호시간대 필터링]
    B --> C[3. 반경 필터링 15km]
    C --> D[4. 선호조건 필터링 LLM]
    D --> E[5. ETA 계산]
    E --> F[6. 최종 선정 상위 5명]
```

1. **요청 검증**: 서비스 요청 위치 DTO 수신 및 좌표 유효성 검증
2. **선호시간대 필터링**: 신청자 선호시간대와 요양보호사 근무시간대 겹침 확인 → **기존 설계에서 누락된 단계로 새롭게 구현 필요**
3. **반경 필터링**: 15km 반경 내 근거리 후보군 로드 (Haversine 공식 사용)
4. **선호조건 필터링**: OpenRouter LLM으로 조건부합 후보군 생성 → ✅ **PR #25에서 구현 완료**
5. **ETA 계산**: 네이버 Direction 5 API를 통한 실제 소요시간 계산 → ✅ **PR #24에서 구현 완료**
6. **최종 선정**: ETA 기준 정렬 후 상위 5명 선정

## 🔄 현재 Stacking Workflow 상태

### PR 의존성 체인
```
PR #20 (gRPC 구현) → PR #21 (네이버 지도 API 스터브) → PR #23 (위치 필터링) → PR #24 (ETA 계산) → PR #25 (LLM 필터링) ✅
```

- ✅ **PR #20**: gRPC 서버/클라이언트 구현 완료 (MERGED)
- ✅ **PR #21**: 네이버 지도 API 클라이언트 구현 및 목 데이터 추가 (MERGED)
- ✅ **PR #22**: OpenRouter LLM 서비스 구현 완료 (MERGED) - 자연어 → 구조화된 데이터 변환
- ✅ **PR #23**: 위치 기반 15km 반경 필터링 시스템 구현 (MERGED)
- ✅ **PR #24**: 네이버 Direction 5 API를 이용한 실시간 ETA 계산 구현 (MERGED)
- ✅ **PR #25**: OpenRouter LLM 서비스 연동한 선호조건 필터링 구현 완료

## ✅ 최근 완료된 작업 요약 (2025-08-31)

### 주요 성과
- **LLM 기반 선호조건 필터링 시스템 완료**: OpenRouter Gemini 2.5 Flash 모델 통합
- **실시간 ETA 계산 구현**: 네이버 Direction 5 API 연동 완료 (목 데이터 기반 작동)
- **gRPC 서비스 통합**: HTTP API와 동일한 매칭 프로세스 사용으로 일관성 확보
- **자연어 변환 검증**: 3개 테스트 케이스에서 정확한 구조화된 데이터 변환 확인
- **선호조건 필터링 로직 구현 완료**: CaregiverPreference DTO 기반 True/False 필터링 시스템 구축
- **데이터베이스 ORM 연동 완료**: SQLAlchemy를 사용한 Spring Boot 데이터베이스 읽기 전용 연동 구현

### 현재 상태
- 매칭 프로세스 4. 선호조건 필터링 구현 완료
- `evaluate_caregiver_match()` 함수가 True/False 필터 함수로 리팩토링 완료
- 선호시간대 매칭 로직 누락됨 → **주요 개선 필요 사항**
- **근무지역 필터 제외**: 15km 반경 필터링과 목적이 겹쳐 work_area 필터링은 구현에서 제외됨
- **데이터베이스 ORM 연동**: 더미 데이터 대신 실제 Spring Boot 데이터베이스에서 요양보호사 정보 조회

## 🎯 다음 구현 작업 - 선호시간대 필터링 및 매칭 로직 완성

### 📋 작업 개요
**목표**: 신청자 선호시간대와 요양보호사 근무시간대가 겹치지 않는 경우 후보군에서 조기 제외

**최적화 목표**: 
- 선호시간대 필터링을 가장 먼저 적용하여 불필요한 위치 계산 방지
- ORM 접근 1회 유지 (현재 구조에서 이미 충족)
- 응답 DTO 형식에 맞춘 완전한 매칭 결과 반환

### 📝 상세 작업 To-Do List

#### 1. 선호시간대 비교 유틸리티 함수 구현
- [x] **파일**: `app/utils/time_utils.py` 신규 생성
- [x] 시간 문자열(HH:MM) 파싱 함수 구현
- [x] 시간대 겹침 확인 로직 구현
- [x] DB 속 요양보호사 리스트에서 근무시간 기반 필터링 함수 구현

#### 2. 매칭 프로세스 개선
- [x] **수정 파일**: `app/api/matching.py`
- [x] 선호시간대 필터링 단계 추가 (요청 검증 후, 반경 필터링 전)
- [x] `filter_by_time_preferences()` 함수 구현
- [x] 기존 프로세스 흐름 5단계 → 6단계로 확장

#### 3. 실제 매칭 로직 구현 완성
- [x] **수정 함수**: `evaluate_caregiver_match()` (라인 308-341)
- [x] 현재 기본 구현에서 실제 비즈니스 로직으로 완전 교체
- [x] 시간대 외 추가 조건 매칭 로직 구현:
  - 서비스 유형 매칭 (`structured_preferences.service_types` vs 서비스 요청 유형)
  - 근무 시간 매칭 (`work_start_time`, `work_end_time` vs 요청된 서비스 시간)
  - 지원 질환 매칭 (`supported_conditions` vs 환자 질환 정보)
  - 선호 성별/연령 매칭 (`preferred_gender`, `preferred_min_age`, `preferred_max_age` vs 환자 정보)
  - 요일 매칭 (`day_of_week` vs 요청 날짜)
- [x] **근무 지역 매칭 제외**: 15km 반경 필터링과 목적이 겹쳐 `work_area` 필터링은 구현에서 제외됨
- [x] ~~매칭 점수 계산 시스템 도입~~ 점수 대신 매칭 방식으로 구현

#### 4. 응답 DTO 완성도 개선
- [x] **수정 함수**: `create_response_dtos()`
- [x] 매칭된 요양보호사의 실제 정보를 응답 DTO에 완전히 매핑
- [x] matchScore는 순위를 나타내는 값으로 사용 (1위: 1, 2위: 2, ...)
- [x] matchReason은 빈 문자열로 설정 (추후 개발 예정)
- [x] 모든 필드가 정확히 채워진 응답 반환 보장

#### 5. api/mathing.py HTTP API 검증 스크립트 작성
- [ ] **파일**: `test_time_matching_validation.py` 신규 생성
- [ ] DB로부터 요양보호사 정보 로드
- [ ] 선호시간대 필터링 함수 검증 스크립트 작성
- [ ] 신청자 선호시간대와 요양보호사 근무시간대 겹침 확인 로직 검증
- [ ] 실제 데이터로 간단한 통합 테스트 수행

## 🔍 현재 구현 상태 분석 (`app/api/matching.py`)

### 완료된 부분
- ✅ 기본 매칭 프로세스 5단계 구조
- ✅ 요청 검증 및 반경 필터링
- ✅ LLM 연동 기반 선호조건 변환
- ✅ 네이버 Direction API 기반 ETA 계산
- ✅ 최종 후보 선정 및 응답 DTO 생성 기본框架

### 미완성/개선 필요 부분
- ⚠️ 선호시간대 필터링 단계 완전히 누락됨
- ⚠️ 응답 DTO의 matchScore가 단순 계산됨 (10 - i 방식)
- ⚠️ matchReason이 단순 문자열로 설정됨
- ⚠️ 실제 비즈니스 매칭 로직 부분 구현됨 (True/False 필터링으로 전환)
- ⚠️ ORM 모델과 실제 데이터베이스 스키마 일치 여부 검증 필요

**해결 방안:**
- matchScore: 순위 값을 그대로 사용 (1위: 1, 2위: 2, ... 5위: 5)
- matchReason: 빈 문자열로 설정 (추후 상세 매칭 이유 구현 시 추가)
- **근무지역 필터 제외**: 15km 반경 필터링과 목적이 겹쳐 `work_area` 필터링은 구현에서 제외됨
- **매칭 방식 변경**: 점수 기반 평가에서 True/False 필터링으로 전환하여 단순화
- **ORM 스키마 검증**: Spring Boot 데이터베이스 실제 스키마와 ORM 모델 일치 여부 확인 필요

## 🔗 참고해야 할 파일들

- `app/api/matching.py`: 주요 매칭 로직 (현재 분석 완료)
- `app/dto/matching.py`: DTO 구조
- `app/models/matching.py`: SQLAlchemy ORM 모델
- `app/dto/converting.py`: 구조화된 선호조건 데이터 모델
- `app/utils/location_calculator.py`: 위치 계산 유틸리티
- `app/database.py`: 데이터베이스 연결 설정
- `app/repositories/caregiver_repository.py`: 요양보호사 데이터 리포지토리

## 🚀 구현 예상 효과

- **성능 향상**: 시간대가 맞지 않는 요양보호사는 위치 계산조차 하지 않아 처리량 감소
- **정확도 향상**: 실제 비즈니스 요구사항 반영한 매칭 로직 구현
- **사용자 경험 개선**: 더 정확하고 빠른 매칭 결과 제공
- **시스템 완성도 향상**: 응답 DTO의 모든 필드가 실제 데이터로 채워짐

---

**마지막 업데이트**: 2025-08-31
**현재 브랜치**: `i-11/matching-api`
**현재 상태**: 데이터베이스 ORM 연동 완료, 선호시간대 필터링 시스템 설계 완료
**다음 작업**: 선호시간대 비교 유틸리티 함수 구현 시작

### 🎯 다음 작업자를 위한 가이드
1. **검증 방법**: 간단한 검증 스크립트 작성으로 기능 확인 (기존 gRPC/LLM 테스트 방식 참고)
2. **주의사항**: ORM 접근 1회 원칙 유지하며 구현
3. **데이터베이스 연동 확인**: ORM 설정이 정상적으로 작동하는지 테스트 (데이터베이스 연결 문자열 확인 필요)
4. **검증 스크립트 작성**: 데이터베이스 ORM 연동 검증을 위한 테스트 스크립트 작성
   - 데이터베이스 연결 테스트
   - ORM 모델과 실제 스키마 매핑 검증
   - 실제 데이터 조회 기능 테스트
5. **환경 변수 설정**: `.env` 파일에 DATABASE_URL 설정 확인
   ```bash
   DATABASE_URL=postgresql+asyncpg://username:password@localhost:5432/homecare_db
   ```
