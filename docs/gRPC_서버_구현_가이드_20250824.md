# gRPC ì„œë²„/í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„ ê°€ì´ë“œ - 2025.08.24

## ğŸ“‹ ë¬¸ì„œ ê°œìš”
ë³¸ ë¬¸ì„œëŠ” ì¬ê°€ê°€ìš” ì‹œìŠ¤í…œì˜ ë§¤ì¹­ì—”ì§„ì—ì„œ FastAPIì™€ gRPCë¥¼ í†µí•©í•œ ì„œë²„ êµ¬í˜„ ê³¼ì •ê³¼ ì‚¬ìš© ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

**ì‘ì„±ì¼**: 2025ë…„ 8ì›” 24ì¼  
**ì´ìŠˆ**: [#2] gRPC ì„œë²„/í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„  
**ë‹´ë‹¹ì**: ê¹€ì¬í›ˆ

## ğŸ¯ êµ¬í˜„ ëª©í‘œ

Spring Boot ë°±ì—”ë“œ ì„œë²„ê°€ Python ë§¤ì¹­ ì—”ì§„ê³¼ íš¨ìœ¨ì ìœ¼ë¡œ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ gRPC ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬ì¶•í•˜ì—¬, REST APIì™€ gRPCë¥¼ í•˜ë‚˜ì˜ í†µí•© ì„œë²„ì—ì„œ ë™ì‹œì— ì œê³µí•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    í†µí•© ì„œë²„ (Python)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FastAPI Server          â”‚  gRPC Server                    â”‚
â”‚  - REST API              â”‚  - ë§¤ì¹­ ì„œë¹„ìŠ¤                   â”‚
â”‚  - í¬íŠ¸: 8000            â”‚  - í¬íŠ¸: 50051                  â”‚
â”‚  - Swagger ë¬¸ì„œ          â”‚  - í”„ë¡œí† ì½œ ë²„í¼                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Spring Boot ì„œë²„                              â”‚
â”‚  - gRPC í´ë¼ì´ì–¸íŠ¸                                           â”‚
â”‚  - ë§¤ì¹­ ìš”ì²­ ì „ì†¡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
homecare_matching/
â”œâ”€â”€ proto/                           # gRPC í”„ë¡œí† ì½œ ì •ì˜
â”‚   â””â”€â”€ matching_service.proto       # ë§¤ì¹­ ì„œë¹„ìŠ¤ í”„ë¡œí† ì½œ
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ grpc_generated/              # ìƒì„±ëœ gRPC ì½”ë“œ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ matching_service_pb2.py
â”‚   â”‚   â””â”€â”€ matching_service_pb2_grpc.py
â”‚   â”œâ”€â”€ grpc_service.py              # gRPC ì„œë¹„ìŠ¤ êµ¬í˜„
â”‚   â”œâ”€â”€ main.py                      # í†µí•© ì„œë²„ main (ìˆ˜ì •ë¨)
â”‚   â”œâ”€â”€ models/matching.py           # DB ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ëª¨ë¸ (ìˆ˜ì •ë¨)
â”‚   â””â”€â”€ dto/matching.py              # DB ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ DTO (ìˆ˜ì •ë¨)
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ 05_gRPC_ì„œë²„_êµ¬í˜„_ê°€ì´ë“œ_20250824.md
â”œâ”€â”€ run_server.py                    # í†µí•© ì„œë²„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ test_grpc_client.py             # gRPC í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸
â””â”€â”€ requirements.txt                 # ì˜ì¡´ì„± (gRPC ì¶”ê°€ë¨)
```

## ğŸ”§ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ëª¨ë¸ ì—…ë°ì´íŠ¸

ì‹¤ì œ ERDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê¸°ì¡´ ëª¨ë¸ë“¤ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤:

#### ServiceRequest ëª¨ë¸
```python
class ServiceRequest(BaseModel):
    service_request_id: str
    consumer_id: str
    service_address: str
    address_type: Optional[str]
    location: str  # "ìœ„ë„,ê²½ë„" ë¬¸ìì—´
    preferred_time: Optional[str]
    duration: Optional[str]
    service_type: Optional[str]
    request_status: Optional[str]
    request_date: Optional[str]
    additional_information: Optional[str]
```

#### Caregiver ëª¨ë¸
```python
class Caregiver(BaseModel):
    caregiver_id: str
    user_id: str
    available_times: Optional[str]
    address: Optional[str]
    service_type: Optional[str]
    days_off: Optional[str]
    career: Optional[str]
    korean_proficiency: Optional[str]
    is_accompany_outing: Optional[bool]
    self_introduction: Optional[str]
    is_verified: Optional[bool]
```

### 2. gRPC í”„ë¡œí† ì½œ ì •ì˜

`proto/matching_service.proto`ì—ì„œ ì„œë¹„ìŠ¤ì™€ ë©”ì‹œì§€ë¥¼ ì •ì˜:

```protobuf
service MatchingService {
  rpc GetMatchingRecommendations(MatchingRequest) returns (MatchingResponse);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message MatchingRequest {
  ServiceRequest service_request = 1;
  repeated CaregiverForMatching candidate_caregivers = 2;
}

message MatchingResponse {
  repeated MatchedCaregiver matched_caregivers = 1;
  int32 total_matches = 2;
  string processing_time_ms = 3;
  bool success = 4;
  string error_message = 5;
}
```

### 3. í†µí•© ì„œë²„ êµ¬í˜„

**FastAPI + gRPC ë™ì‹œ ì‹¤í–‰**ì„ ìœ„í•œ `lifespan` ì´ë²¤íŠ¸ ì‚¬ìš©:

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    global grpc_task
    
    # ì‹œì‘ ì‹œ gRPC ì„œë²„ ì‹¤í–‰
    logger.info("í†µí•© ì„œë²„ ì‹œì‘: FastAPI + gRPC")
    grpc_task = asyncio.create_task(serve_grpc(50051))
    
    yield
    
    # ì¢…ë£Œ ì‹œ gRPC ì„œë²„ ì •ë¦¬
    if grpc_task:
        grpc_task.cancel()

app = FastAPI(
    title="Homecare Matching API",
    description="ê±°ë¦¬ ê¸°ë°˜ ìš”ì–‘ë³´í˜¸ì‚¬ ë§¤ì¹­ ì„œë¹„ìŠ¤ (FastAPI + gRPC)",
    lifespan=lifespan
)
```

### 4. gRPC ì„œë¹„ìŠ¤ êµ¬í˜„

`app/grpc_service.py`ì—ì„œ ë§¤ì¹­ ì„œë¹„ìŠ¤ êµ¬í˜„:

```python
class MatchingServiceServicer(matching_service_pb2_grpc.MatchingServiceServicer):
    def GetMatchingRecommendations(self, request, context):
        # gRPC ìš”ì²­ì„ ë‚´ë¶€ DTOë¡œ ë³€í™˜
        # ê¸°ì¡´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ ì‹¤í–‰
        # ê²°ê³¼ë¥¼ gRPC ì‘ë‹µìœ¼ë¡œ ë³€í™˜
        
    def HealthCheck(self, request, context):
        # í—¬ìŠ¤ì²´í¬ ì²˜ë¦¬
```

## ğŸš€ ì„œë²„ ì‹¤í–‰ ë°©ë²•

### 1. ì˜ì¡´ì„± ì„¤ì¹˜
```bash
pip install -r requirements.txt
```

### 2. í†µí•© ì„œë²„ ì‹¤í–‰
```bash
python run_server.py
```

### 3. ì„œë²„ í™•ì¸
- **REST API**: http://localhost:8000
- **API ë¬¸ì„œ**: http://localhost:8000/docs
- **gRPC ì„œë²„**: localhost:50051

### 4. í—¬ìŠ¤ì²´í¬
```bash
curl http://localhost:8000/health-check
```

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "status": "ok",
  "message": "Homecare Matching API is running",
  "services": {
    "fastapi": "running",
    "grpc": "running on port 50051"
  }
}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### gRPC í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
python test_grpc_client.py
```

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:
```
ğŸ§ª gRPC ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œì‘
==================================================

1. í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ:
   ìƒíƒœ: 1
   ë©”ì‹œì§€: Homecare Matching gRPC Service is running

2. ë§¤ì¹­ ìš”ì²­ í…ŒìŠ¤íŠ¸
âœ… ë§¤ì¹­ ìš”ì²­ ì„±ê³µ:
   ë§¤ì¹­ëœ ìš”ì–‘ë³´í˜¸ì‚¬ ìˆ˜: 2
   ì²˜ë¦¬ ì‹œê°„: 0.39ms

   1ìˆœìœ„:
     ID: caregiver-001
     ì ìˆ˜: 10.0
     ê±°ë¦¬: 0.00km
     ë§¤ì¹­ ì´ìœ : 1ìˆœìœ„ | ë§¤ìš° ê°€ê¹Œìš´ ê±°ë¦¬ (0.02km) | ì¶©ë¶„í•œ ê²½ë ¥ (3ë…„) | ë§¤ì¹­ ì ìˆ˜ 10ì 
     ê²€ì¦ ìƒíƒœ: âœ“

ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! gRPC ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
```

## ğŸ“ Spring Bootì—ì„œ gRPC í´ë¼ì´ì–¸íŠ¸ ì—°ë™

### 1. Spring Boot ì˜ì¡´ì„± ì¶”ê°€

```xml
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-netty-shaded</artifactId>
    <version>1.68.1</version>
</dependency>
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-protobuf</artifactId>
    <version>1.68.1</version>
</dependency>
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-stub</artifactId>
    <version>1.68.1</version>
</dependency>
```

### 2. proto íŒŒì¼ ì»´íŒŒì¼

Spring Boot í”„ë¡œì íŠ¸ì—ì„œ ë™ì¼í•œ `matching_service.proto` íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ Java ì½”ë“œ ìƒì„±:

```bash
# Maven í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš©
mvn compile
```

### 3. gRPC í´ë¼ì´ì–¸íŠ¸ êµ¬ì„±

```java
@Service
public class MatchingGrpcClient {
    
    private final MatchingServiceGrpc.MatchingServiceBlockingStub stub;
    
    public MatchingGrpcClient() {
        ManagedChannel channel = NettyChannelBuilder.forAddress("localhost", 50051)
            .usePlaintext()
            .build();
        this.stub = MatchingServiceGrpc.newBlockingStub(channel);
    }
    
    public MatchingResponse getMatchingRecommendations(MatchingRequest request) {
        return stub.getMatchingRecommendations(request);
    }
    
    public HealthCheckResponse healthCheck() {
        HealthCheckRequest request = HealthCheckRequest.newBuilder()
            .setService("matching")
            .build();
        return stub.healthCheck(request);
    }
}
```

### 4. ë§¤ì¹­ ìš”ì²­ ì˜ˆì‹œ

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingController {
    
    @Autowired
    private MatchingGrpcClient grpcClient;
    
    @PostMapping("/recommend")
    public ResponseEntity<?> getRecommendations(@RequestBody MatchingRequestDto dto) {
        // DTOë¥¼ gRPC ë©”ì‹œì§€ë¡œ ë³€í™˜
        MatchingRequest grpcRequest = convertToGrpcRequest(dto);
        
        // gRPC ì„œë²„ì— ìš”ì²­
        MatchingResponse response = grpcClient.getMatchingRecommendations(grpcRequest);
        
        // ì‘ë‹µì„ REST API í˜•íƒœë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
        return ResponseEntity.ok(convertToRestResponse(response));
    }
}
```

## ğŸ” API ìŠ¤í™

### gRPC ì„œë¹„ìŠ¤ ë©”ì†Œë“œ

#### 1. GetMatchingRecommendations
- **ì„¤ëª…**: ìš”ì–‘ë³´í˜¸ì‚¬ ë§¤ì¹­ ì¶”ì²œ ìš”ì²­
- **ìš”ì²­**: `MatchingRequest`
- **ì‘ë‹µ**: `MatchingResponse`

#### 2. HealthCheck
- **ì„¤ëª…**: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
- **ìš”ì²­**: `HealthCheckRequest`
- **ì‘ë‹µ**: `HealthCheckResponse`

### REST API ì—”ë“œí¬ì¸íŠ¸

#### 1. POST /matching/recommend
- **ì„¤ëª…**: ë§¤ì¹­ ì¶”ì²œ ìš”ì²­ (ê¸°ì¡´ REST API)
- **ìš”ì²­**: `MatchingRequestDTO`
- **ì‘ë‹µ**: `MatchingResponseDTO`

#### 2. GET /health-check
- **ì„¤ëª…**: ì„œë²„ ìƒíƒœ í™•ì¸
- **ì‘ë‹µ**: ì„œë²„ ìƒíƒœ ì •ë³´

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. í¬íŠ¸ ì¶©ëŒ
- FastAPI: 8000ë²ˆ í¬íŠ¸
- gRPC: 50051ë²ˆ í¬íŠ¸
- í•´ë‹¹ í¬íŠ¸ë“¤ì´ ì‚¬ìš© ì¤‘ì´ì§€ ì•Šì€ì§€ í™•ì¸

### 2. ìƒì„±ëœ gRPC ì½”ë“œ
- `app/grpc_generated/` ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ë“¤ì€ ìë™ ìƒì„±ë¨
- ì§ì ‘ ìˆ˜ì •í•˜ì§€ ë§ê³ , proto íŒŒì¼ ìˆ˜ì • í›„ ì¬ìƒì„± ì‚¬ìš©

### 3. ì„œë²„ ì¬ì‹œì‘
- proto íŒŒì¼ ë³€ê²½ ì‹œ ì„œë²„ ì¬ì‹œì‘ í•„ìš”
- ê°œë°œ ì¤‘ì—ëŠ” `reload=True` ì˜µì…˜ ì‚¬ìš©

## ğŸ“Š ì„±ëŠ¥ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ í™˜ê²½
- **ì„œë²„**: MacBook (M ì‹œë¦¬ì¦ˆ)
- **í…ŒìŠ¤íŠ¸ ë°ì´í„°**: ìš”ì–‘ë³´í˜¸ì‚¬ 2ëª…
- **ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜**: ê±°ë¦¬ ê¸°ë°˜ Haversine ê³µì‹

### ì„±ëŠ¥ ì§€í‘œ
- **ë§¤ì¹­ ì²˜ë¦¬ ì‹œê°„**: 0.39ms
- **ì‘ë‹µ ì‹œê°„**: < 1ms
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ì •ìƒ ë²”ìœ„
- **ë™ì‹œ ì—°ê²°**: ì§€ì› (ThreadPoolExecutor ì‚¬ìš©)

## ğŸ”„ í–¥í›„ ê°œì„  ê³„íš

1. **ì¸ì¦/ê¶Œí•œ ì¶”ê°€**: gRPC ì¸í„°ì…‰í„°ë¥¼ í†µí•œ ë³´ì•ˆ ê°•í™”
2. **ë¡œë“œ ë°¸ëŸ°ì‹±**: ë‹¤ì¤‘ gRPC ì„œë²„ ì§€ì›
3. **ë©”íŠ¸ë¦­ ìˆ˜ì§‘**: Prometheus/Grafana ì—°ë™
4. **ì—ëŸ¬ í•¸ë“¤ë§**: ë” ì„¸ë°€í•œ ì˜¤ë¥˜ ìƒí™© ì²˜ë¦¬
5. **ìŠ¤íŠ¸ë¦¬ë°**: ì‹¤ì‹œê°„ ë§¤ì¹­ ì—…ë°ì´íŠ¸ ì§€ì›

## ğŸ“ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: ModuleNotFoundError
**ì¦ìƒ**: `ModuleNotFoundError: No module named 'grpc_generated'`
**í•´ê²°**: import ê²½ë¡œ ìˆ˜ì • (`from .grpc_generated import ...`)

### ë¬¸ì œ 2: í¬íŠ¸ ì´ë¯¸ ì‚¬ìš© ì¤‘
**ì¦ìƒ**: `Address already in use`
**í•´ê²°**: í¬íŠ¸ ë³€ê²½ ë˜ëŠ” ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ

### ë¬¸ì œ 3: gRPC ì—°ê²° ì‹¤íŒ¨
**ì¦ìƒ**: `grpc._channel._InactiveRpcError`
**í•´ê²°**: ì„œë²„ ì‹¤í–‰ ìƒíƒœ í™•ì¸, ë°©í™”ë²½ ì„¤ì • í™•ì¸

## ğŸ“š ì°¸ê³  ìë£Œ

- [gRPC Python ê³µì‹ ë¬¸ì„œ](https://grpc.io/docs/languages/python/)
- [FastAPI ê³µì‹ ë¬¸ì„œ](https://fastapi.tiangolo.com/)
- [Protocol Buffers ê°€ì´ë“œ](https://protobuf.dev/)
- [Spring Boot gRPC ê°€ì´ë“œ](https://github.com/yidongnan/grpc-spring-boot-starter)

---

**ë¬¸ì„œ ì‘ì„±**: Claude AI Assistant  
**ìµœì¢… ê²€í† **: 2025.08.24