# gRPC 서버/클라이언트 구현 가이드 - 2025.08.24

## 📋 문서 개요
본 문서는 재가가요 시스템의 매칭엔진에서 FastAPI와 gRPC를 통합한 서버 구현 과정과 사용 방법을 설명합니다.

**작성일**: 2025년 8월 24일  
**이슈**: [#2] gRPC 서버/클라이언트 구현  
**담당자**: 김재훈

## 🎯 구현 목표

Spring Boot 백엔드 서버가 Python 매칭 엔진과 효율적으로 통신할 수 있도록 gRPC 인터페이스를 구축하여, REST API와 gRPC를 하나의 통합 서버에서 동시에 제공합니다.

## 🏗️ 아키텍처 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    통합 서버 (Python)                        │
├─────────────────────────────────────────────────────────────┤
│  FastAPI Server          │  gRPC Server                    │
│  - REST API              │  - 매칭 서비스                   │
│  - 포트: 8000            │  - 포트: 50051                  │
│  - Swagger 문서          │  - 프로토콜 버퍼                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                Spring Boot 서버                              │
│  - gRPC 클라이언트                                           │
│  - 매칭 요청 전송                                            │
└─────────────────────────────────────────────────────────────┘
```

## 📁 프로젝트 구조

```
homecare_matching/
├── proto/                           # gRPC 프로토콜 정의
│   └── matching_service.proto       # 매칭 서비스 프로토콜
├── app/
│   ├── grpc_generated/              # 생성된 gRPC 코드
│   │   ├── __init__.py
│   │   ├── matching_service_pb2.py
│   │   └── matching_service_pb2_grpc.py
│   ├── grpc_service.py              # gRPC 서비스 구현
│   ├── main.py                      # 통합 서버 main (수정됨)
│   ├── models/matching.py           # DB 스키마 기반 모델 (수정됨)
│   └── dto/matching.py              # DB 스키마 기반 DTO (수정됨)
├── docs/
│   └── 05_gRPC_서버_구현_가이드_20250824.md
├── run_server.py                    # 통합 서버 실행 스크립트
├── test_grpc_client.py             # gRPC 클라이언트 테스트
└── requirements.txt                 # 의존성 (gRPC 추가됨)
```

## 🔧 구현 세부사항

### 1. 데이터베이스 스키마 기반 모델 업데이트

실제 ERD를 기반으로 기존 모델들을 수정했습니다:

#### ServiceRequest 모델
```python
class ServiceRequest(BaseModel):
    service_request_id: str
    consumer_id: str
    service_address: str
    address_type: Optional[str]
    location: str  # "위도,경도" 문자열
    preferred_time: Optional[str]
    duration: Optional[str]
    service_type: Optional[str]
    request_status: Optional[str]
    request_date: Optional[str]
    additional_information: Optional[str]
```

#### Caregiver 모델
```python
class Caregiver(BaseModel):
    caregiver_id: str
    user_id: str
    available_times: Optional[str]
    address: Optional[str]
    service_type: Optional[str]
    days_off: Optional[str]
    career: Optional[str]
    korean_proficiency: Optional[str]
    is_accompany_outing: Optional[bool]
    self_introduction: Optional[str]
    is_verified: Optional[bool]
```

### 2. gRPC 프로토콜 정의

`proto/matching_service.proto`에서 서비스와 메시지를 정의:

```protobuf
service MatchingService {
  rpc GetMatchingRecommendations(MatchingRequest) returns (MatchingResponse);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message MatchingRequest {
  ServiceRequest service_request = 1;
  repeated CaregiverForMatching candidate_caregivers = 2;
}

message MatchingResponse {
  repeated MatchedCaregiver matched_caregivers = 1;
  int32 total_matches = 2;
  string processing_time_ms = 3;
  bool success = 4;
  string error_message = 5;
}
```

### 3. 통합 서버 구현

**FastAPI + gRPC 동시 실행**을 위한 `lifespan` 이벤트 사용:

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    global grpc_task
    
    # 시작 시 gRPC 서버 실행
    logger.info("통합 서버 시작: FastAPI + gRPC")
    grpc_task = asyncio.create_task(serve_grpc(50051))
    
    yield
    
    # 종료 시 gRPC 서버 정리
    if grpc_task:
        grpc_task.cancel()

app = FastAPI(
    title="Homecare Matching API",
    description="거리 기반 요양보호사 매칭 서비스 (FastAPI + gRPC)",
    lifespan=lifespan
)
```

### 4. gRPC 서비스 구현

`app/grpc_service.py`에서 매칭 서비스 구현:

```python
class MatchingServiceServicer(matching_service_pb2_grpc.MatchingServiceServicer):
    def GetMatchingRecommendations(self, request, context):
        # gRPC 요청을 내부 DTO로 변환
        # 기존 매칭 알고리즘 실행
        # 결과를 gRPC 응답으로 변환
        
    def HealthCheck(self, request, context):
        # 헬스체크 처리
```

## 🚀 서버 실행 방법

### 1. 의존성 설치
```bash
pip install -r requirements.txt
```

### 2. 통합 서버 실행
```bash
python run_server.py
```

### 3. 서버 확인
- **REST API**: http://localhost:8000
- **API 문서**: http://localhost:8000/docs
- **gRPC 서버**: localhost:50051

### 4. 헬스체크
```bash
curl http://localhost:8000/health-check
```

**응답 예시**:
```json
{
  "status": "ok",
  "message": "Homecare Matching API is running",
  "services": {
    "fastapi": "running",
    "grpc": "running on port 50051"
  }
}
```

## 🧪 테스트 방법

### gRPC 클라이언트 테스트 실행
```bash
python test_grpc_client.py
```

**테스트 결과**:
```
🧪 gRPC 서비스 테스트 시작
==================================================

1. 헬스체크 테스트
✅ 헬스체크 성공:
   상태: 1
   메시지: Homecare Matching gRPC Service is running

2. 매칭 요청 테스트
✅ 매칭 요청 성공:
   매칭된 요양보호사 수: 2
   처리 시간: 0.39ms

   1순위:
     ID: caregiver-001
     점수: 10.0
     거리: 0.00km
     매칭 이유: 1순위 | 매우 가까운 거리 (0.02km) | 충분한 경력 (3년) | 매칭 점수 10점
     검증 상태: ✓

🎉 모든 테스트 통과! gRPC 서비스가 정상적으로 동작합니다.
```

## 📞 Spring Boot에서 gRPC 클라이언트 연동

### 1. Spring Boot 의존성 추가

```xml
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-netty-shaded</artifactId>
    <version>1.68.1</version>
</dependency>
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-protobuf</artifactId>
    <version>1.68.1</version>
</dependency>
<dependency>
    <groupId>io.grpc</groupId>
    <artifactId>grpc-stub</artifactId>
    <version>1.68.1</version>
</dependency>
```

### 2. proto 파일 컴파일

Spring Boot 프로젝트에서 동일한 `matching_service.proto` 파일을 사용하여 Java 코드 생성:

```bash
# Maven 플러그인 사용
mvn compile
```

### 3. gRPC 클라이언트 구성

```java
@Service
public class MatchingGrpcClient {
    
    private final MatchingServiceGrpc.MatchingServiceBlockingStub stub;
    
    public MatchingGrpcClient() {
        ManagedChannel channel = NettyChannelBuilder.forAddress("localhost", 50051)
            .usePlaintext()
            .build();
        this.stub = MatchingServiceGrpc.newBlockingStub(channel);
    }
    
    public MatchingResponse getMatchingRecommendations(MatchingRequest request) {
        return stub.getMatchingRecommendations(request);
    }
    
    public HealthCheckResponse healthCheck() {
        HealthCheckRequest request = HealthCheckRequest.newBuilder()
            .setService("matching")
            .build();
        return stub.healthCheck(request);
    }
}
```

### 4. 매칭 요청 예시

```java
@RestController
@RequestMapping("/api/matching")
public class MatchingController {
    
    @Autowired
    private MatchingGrpcClient grpcClient;
    
    @PostMapping("/recommend")
    public ResponseEntity<?> getRecommendations(@RequestBody MatchingRequestDto dto) {
        // DTO를 gRPC 메시지로 변환
        MatchingRequest grpcRequest = convertToGrpcRequest(dto);
        
        // gRPC 서버에 요청
        MatchingResponse response = grpcClient.getMatchingRecommendations(grpcRequest);
        
        // 응답을 REST API 형태로 변환하여 반환
        return ResponseEntity.ok(convertToRestResponse(response));
    }
}
```

## 🔍 API 스펙

### gRPC 서비스 메소드

#### 1. GetMatchingRecommendations
- **설명**: 요양보호사 매칭 추천 요청
- **요청**: `MatchingRequest`
- **응답**: `MatchingResponse`

#### 2. HealthCheck
- **설명**: 서비스 상태 확인
- **요청**: `HealthCheckRequest`
- **응답**: `HealthCheckResponse`

### REST API 엔드포인트

#### 1. POST /matching/recommend
- **설명**: 매칭 추천 요청 (기존 REST API)
- **요청**: `MatchingRequestDTO`
- **응답**: `MatchingResponseDTO`

#### 2. GET /health-check
- **설명**: 서버 상태 확인
- **응답**: 서버 상태 정보

## ⚠️ 주의사항

### 1. 포트 충돌
- FastAPI: 8000번 포트
- gRPC: 50051번 포트
- 해당 포트들이 사용 중이지 않은지 확인

### 2. 생성된 gRPC 코드
- `app/grpc_generated/` 디렉토리의 파일들은 자동 생성됨
- 직접 수정하지 말고, proto 파일 수정 후 재생성 사용

### 3. 서버 재시작
- proto 파일 변경 시 서버 재시작 필요
- 개발 중에는 `reload=True` 옵션 사용

## 📊 성능 결과

### 테스트 환경
- **서버**: MacBook (M 시리즈)
- **테스트 데이터**: 요양보호사 2명
- **매칭 알고리즘**: 거리 기반 Haversine 공식

### 성능 지표
- **매칭 처리 시간**: 0.39ms
- **응답 시간**: < 1ms
- **메모리 사용량**: 정상 범위
- **동시 연결**: 지원 (ThreadPoolExecutor 사용)

## 🔄 향후 개선 계획

1. **인증/권한 추가**: gRPC 인터셉터를 통한 보안 강화
2. **로드 밸런싱**: 다중 gRPC 서버 지원
3. **메트릭 수집**: Prometheus/Grafana 연동
4. **에러 핸들링**: 더 세밀한 오류 상황 처리
5. **스트리밍**: 실시간 매칭 업데이트 지원

## 📝 트러블슈팅

### 문제 1: ModuleNotFoundError
**증상**: `ModuleNotFoundError: No module named 'grpc_generated'`
**해결**: import 경로 수정 (`from .grpc_generated import ...`)

### 문제 2: 포트 이미 사용 중
**증상**: `Address already in use`
**해결**: 포트 변경 또는 기존 프로세스 종료

### 문제 3: gRPC 연결 실패
**증상**: `grpc._channel._InactiveRpcError`
**해결**: 서버 실행 상태 확인, 방화벽 설정 확인

## 📚 참고 자료

- [gRPC Python 공식 문서](https://grpc.io/docs/languages/python/)
- [FastAPI 공식 문서](https://fastapi.tiangolo.com/)
- [Protocol Buffers 가이드](https://protobuf.dev/)
- [Spring Boot gRPC 가이드](https://github.com/yidongnan/grpc-spring-boot-starter)

---

**문서 작성**: Claude AI Assistant  
**최종 검토**: 2025.08.24